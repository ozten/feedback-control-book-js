<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Feedback Control</title>
        <style>
            .emscripten { padding-right: 0; margin-left: auto; font-size: 10px; margin-right: auto; display: block; }
            canvas.emscripten { border: 1px solid black; }
            textarea.emscripten { font-family: monospace; width: 80%; }
            div.emscripten { text-align: center; }
            table.noborder { border: 0; vertical-align: text-top; }
        </style>
    </head>
    <body>
        <h1>Feedback Control</h1>
        <hr/>
        <table class="noborder"><tr><td>
                    <img src="" id="gnuimg" type="image/svg+xml" width=600 height=400 class="float-right"/>
                </td><td valign=top style="width:95%;">
                    <textarea class="emscripten" id="gnuplot" rows="35" onkeyup="scriptChange()">
set terminal svg size 600,400 dynamic enhanced fname 'arial'  fsize 10 mousing name "simple_1" butt solid
set output 'out.svg'
# set key inside left top vertical Right noreverse enhanced autotitles box linetype -1 linewidth 1.000
set xrange [0:8]
set yrange [0:]
# set samples 50, 50
# plot [10:30] sin(x),atan(x),cos(atan(x))

plot 'simulation.out' using 1:2 with lines, 'simulation.out' using 1:3 with lines, 'simulation.out' using 1:4 with lines

</textarea>
                </td></tr></table>
        <br clear=all>
        <hr>
        <h2 style="float: left;">Output:</h2>
        <textarea class="emscripten" id="output" rows="8">Loading, please wait. </textarea>
	<h2>Credits</h2>
	<p>Code ported from the Python code from Feedback Control by Philipp K Janert.</p>
        <p>Gnuplot 4.6.3 compiled to JS with <a href='https://github.com/kripken/emscripten'>Emscripten</a></p>
        <script src='/lib/gnuplot_api.js'></script>
        <script>
                var gnuplot = new Gnuplot('/lib/gnuplot.js');
                gnuplot.onOutput = function(text) {
                    document.getElementById('output').value += text + '\n';
                    document.getElementById('output').scrollTop = 99999;
                };
                gnuplot.onError = function(text) {
                    document.getElementById('output').value += 'ERR: ' + text + '\n';
                    document.getElementById('output').scrollTop = 99999;
                };
                var lastTAContent = '';
                function scriptChange() {
                    var val = document.getElementById("gnuplot").value;
                    if (lastTAContent == val)
                        return;
                    localStorage["gnuplot.script"] = val;
                    if (gnuplot.isRunning) {
                        setTimeout(scriptChange, 1000);
                    } else {
                        lastTAContent = val;
                        runScript();
                    }
                }
                ;
                var runScript = function() {
                    var editor = document.getElementById('gnuplot');   // textarea
                    var start = Date.now();

                    gnuplot.putFile('simulation.out', '0 1 2 3 4 5\n1 2 3 4 5 6\n2 3 4 5 6 7\n3 4 5 6 7 8\n4 5 6 7 8 9');

                    var script = "set terminal svg size 600,400 dynamic enhanced fname 'arial'  fsize 10 mousing name " +
		'"simple_1" butt solid \n' +
		"set output 'out.svg' \n" +
		"set key inside left top vertical Right noreverse enhanced autotitles box linetype -1 linewidth 1.000 \n" +
		"set samples 50, 50 \n" +
		'plot [10:30] sin(x),atan(x),cos(atan(x))\n';

console.log(script);
console.log(editor.value);
console.log(script == editor.value);

script = editor.value;



                    gnuplot.run(script, function(e) {
                        gnuplot.onOutput('Execution took ' + (Date.now() - start) / 1000 + 's.');
                        gnuplot.getFile('out.svg', function(e) {
                            if (!e.content) {
                                gnuplot.onError("Output file out.svg not found!");
                                return;
                            }
                            var img = document.getElementById('gnuimg');
                            try {
                                var ab = new Uint8Array(e.content);
                                var blob = new Blob([ab], {"type": "image\/svg+xml"});
                                window.URL = window.URL || window.webkitURL;
                                img.src = window.URL.createObjectURL(blob);
                            } catch (err) { // in case blob / URL missing, fallback to data-uri
                                if (!window.blobalert) {
                                    alert('Warning - your browser does not support Blob-URLs, using data-uri with a lot more memory and time required. Err: ' + err);
                                    window.blobalert = true;
                                }
                                var rstr = '';
                                for (var i = 0; i < e.content.length; i++)
                                    rstr += String.fromCharCode(e.content[i]);
                                img.src = 'data:image\/svg+xml;base64,' + btoa(rstr);
                            }
                        });
                    });
                };
                // set the script from local storage
                if (localStorage["gnuplot.script"])
                    document.getElementById('gnuplot').value = localStorage["gnuplot.script"];
                scriptChange();
                function handleFileSelect(evt) {
                    var _files = evt.target.files; // FileList object

                    // files is a FileList of File objects. List some properties.
                    var output = [];
                    for (var i = 0, f; f = _files[i]; i++) {
                        output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                                f.size, ' bytes, last modified: ',
                                f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                                '</li>');
                        (function() {
                            var reader = new FileReader();
                            var fname = f.name;
                            reader.onloadend = function(e) {
                                if (e.target.result) {
                                    gnuplot.onOutput(fname + ": Read success - storing in browser. " + e.target.result.length);
                                    files[fname] = e.target.result;
                                    localStorage["gnuplot.files"] = JSON.stringify(files);
                                }

                            };
                            reader.readAsText(f);
                        })();
                    }
                    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
                }
                document.getElementById('files').addEventListener('change', handleFileSelect, false);

        </script>

    </body>
</html>
